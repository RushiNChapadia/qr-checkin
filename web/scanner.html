<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>QR Check-in Scanner</title>
  <style>
    body { margin:0; background:#0f0f10; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.14); border-radius: 16px; padding: 16px; }
    .row { display:flex; gap:12px; flex-wrap: wrap; align-items:center; }
    .row > * { flex: 1; min-width: 220px; }
    h1 { font-size: 22px; margin: 0 0 10px; }
    label { display:block; font-size: 12px; opacity: .85; margin-bottom: 6px; }
    input { width:100%; padding: 12px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.18);
            background: rgba(0,0,0,0.35); color:#fff; font-size: 16px; }
    button { padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.18);
             background: rgba(255,255,255,0.10); color:#fff; font-size: 16px; cursor:pointer; }
    button:active { transform: scale(0.99); }
    .status { margin-top: 12px; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.18); }
    .ok { background: rgba(0,255,0,0.10); }
    .warn { background: rgba(255,200,0,0.12); }
    .bad { background: rgba(255,0,0,0.10); }
    .muted { opacity: .75; font-size: 13px; }
    #reader { width: 100%; border-radius: 16px; overflow:hidden; margin-top: 12px; }
    .big { font-size: 18px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; font-size: 12px; opacity: .85; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>QR Check-in Scanner</h1>

      <div class="row">
        <div>
          <label>API Base URL</label>
          <input id="apiBase" placeholder="e.g. https://your-service.onrender.com" />
          <div class="muted">Tip: leave empty to use same origin.</div>
        </div>

        <div>
          <label>Scanner Key (X-Scanner-Key)</label>
          <input id="scannerKey" placeholder="paste scanner key here" />
          <div class="muted">Saved on this device (localStorage).</div>
        </div>

        <div style="flex: 0.7; min-width: 160px;">
          <label>&nbsp;</label>
          <button id="saveBtn">Save</button>
          <button id="startBtn" style="margin-left:8px;">Start</button>
        </div>
      </div>

      <div id="status" class="status muted">Status: not started</div>

      <div id="reader"></div>

      <div class="muted" style="margin-top:10px;">
        Scans token-only QR payloads and formats like <span class="mono">token=...</span> or <span class="mono">...?token=...</span>.
      </div>
      <div class="muted">
        If camera doesn’t open: ensure HTTPS and allow camera permission in Safari settings.
      </div>
    </div>
  </div>

  <!-- QR scanner library -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

  <script>
    const apiBaseInput = document.getElementById("apiBase");
    const scannerKeyInput = document.getElementById("scannerKey");
    const statusEl = document.getElementById("status");
    const saveBtn = document.getElementById("saveBtn");
    const startBtn = document.getElementById("startBtn");

    // Load saved settings
    apiBaseInput.value = localStorage.getItem("qr_api_base") || "";
    scannerKeyInput.value = localStorage.getItem("qr_scanner_key") || "";

    saveBtn.addEventListener("click", () => {
      localStorage.setItem("qr_api_base", apiBaseInput.value.trim());
      localStorage.setItem("qr_scanner_key", scannerKeyInput.value.trim());
      setStatus("Saved settings.", "ok");
    });

    function setStatus(text, kind="muted") {
      statusEl.className = "status " + (kind === "ok" ? "ok" : kind === "warn" ? "warn" : kind === "bad" ? "bad" : "muted");
      statusEl.innerHTML = `<div class="big">${text}</div>`;
    }

    function extractToken(qrText) {
      const t = (qrText || "").trim();

      // 1) token-only
      if (t.length > 10 && !t.includes("=") && !t.includes("http")) return t;

      // 2) token=... (raw)
      const m1 = t.match(/(?:^|[?&])token=([^&]+)/i);
      if (m1 && m1[1]) return decodeURIComponent(m1[1]);

      // 3) qr_token=...
      const m2 = t.match(/(?:^|[?&])qr_token=([^&]+)/i);
      if (m2 && m2[1]) return decodeURIComponent(m2[1]);

      // 4) last fallback: if it looks like a URL, try URL parsing
      try {
        const u = new URL(t);
        const token = u.searchParams.get("token") || u.searchParams.get("qr_token");
        if (token) return token;
      } catch (_) {}

      return null;
    }

    let scanner = null;
    let lastToken = null;
    let lastScanAt = 0;

    async function doCheckin(qrToken) {
      const apiBase = apiBaseInput.value.trim();
      const scannerKey = scannerKeyInput.value.trim();

      if (!scannerKey) {
        setStatus("Missing scanner key. Paste it and press Save.", "warn");
        return;
      }

      const url = (apiBase ? apiBase.replace(/\/+$/, "") : "") + "/api/v1/checkin";

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Scanner-Key": scannerKey
          },
          body: JSON.stringify({ qr_token: qrToken, device_id: "scanner-web" })
        });

        const data = await res.json().catch(() => ({}));

        if (res.ok) {
          if (navigator.vibrate) navigator.vibrate(50);
          const msg = data.already_checked_in
            ? `Already checked in: ${data.full_name}`
            : `✅ Checked in: ${data.full_name}`;
          setStatus(msg, data.already_checked_in ? "warn" : "ok");
        } else {
          const detail = data.detail || `HTTP ${res.status}`;
          setStatus(`❌ Check-in failed: ${detail}`, "bad");
        }
      } catch (e) {
        setStatus(`❌ Network error calling API. Check API Base URL / HTTPS.`, "bad");
      }
    }

    startBtn.addEventListener("click", async () => {
      setStatus("Starting camera…", "muted");

      if (scanner) {
        try { await scanner.stop(); } catch (_) {}
        scanner = null;
      }

      scanner = new Html5Qrcode("reader");
      const config = { fps: 10, qrbox: { width: 280, height: 280 } };

      // try back camera first
      try {
        const cameras = await Html5Qrcode.getCameras();
        const backCam = cameras.find(c => /back|rear|environment/i.test(c.label)) || cameras[0];

        await scanner.start(
          backCam.id,
          config,
          async (decodedText) => {
            const now = Date.now();
            const token = extractToken(decodedText);
            if (!token) {
              setStatus("Scanned QR but could not extract token.", "warn");
              return;
            }

            // simple debounce: ignore same token within 2 seconds
            if (token === lastToken && (now - lastScanAt) < 2000) return;
            lastToken = token;
            lastScanAt = now;

            setStatus(`Scanned. Checking in…`, "muted");
            await doCheckin(token);
          }
        );

        setStatus("Camera started. Scan a QR code.", "ok");
      } catch (e) {
        setStatus("❌ Could not start camera. Allow camera permission + use HTTPS.", "bad");
      }
    });
  </script>
</body>
</html>
